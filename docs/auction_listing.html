<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Property Auction Map</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.0/dist/leaflet.markercluster.css" />

  <style>
    #map { height: 100vh; }
    #sidebar { 
      position: absolute; 
      top: 10px; 
      left: 10px; 
      background: rgba(255, 255, 255, 0.9); 
      padding: 20px; 
      z-index: 1000; 
      border-radius: 8px;
      max-height: 90vh;
      overflow-y: auto;
      width: 260px;
      display: block;
    }
    #toggleSidebar {
      position: absolute;
      top: 10px;
      left: 280px;
      z-index: 1100;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
    }
    .filter-container { margin-bottom: 15px; }
    .filter-container label { font-weight: bold; }
    .filter-container select, .filter-container input { width: 100%; }
  </style>
</head>
<body>

<button id="toggleSidebar">â˜° Filters</button>

<div id="sidebar">
  <h3>Filters</h3>

  <div class="filter-container">
    <label for="property-type">Property Type</label>
    <select id="property-type">
      <option value="">All Types</option>
    </select>
  </div>

  <div class="filter-container">
    <label for="auction-start">Auction Start Date</label>
    <input type="date" id="auction-start">
  </div>

  <div class="filter-container">
    <label for="auction-end">Auction End Date</label>
    <input type="date" id="auction-end">
  </div>

  <div class="filter-container">
    <label for="price-range">Max Price (RM)</label>
    <input type="range" id="price-range" min="0" max="10000000" step="100000">
    <div id="price-output">RM 0 - RM 10,000,000</div>
  </div>

  <div class="filter-container">
    <label for="builtup-range">Max Built-up (sq.ft)</label>
    <input type="range" id="builtup-range" min="0" max="10000" step="100">
    <div id="builtup-output">0 - 10,000 sq.ft</div>
  </div>

  <div class="filter-container">
    <label for="tenure">Tenure</label>
    <select id="tenure">
      <option value="">All</option>
      <option value="FH">Freehold (FH)</option>
      <option value="LH">Leasehold (LH)</option>
    </select>
  </div>

  <div class="filter-container">
    <label for="auction-type">Auction Type</label>
    <select id="auction-type">
      <option value="">All Types</option>
    </select>
  </div>

  <div class="filter-container">
    <label for="transit">Transit Station</label>
    <select id="transit" multiple>
    </select>
  </div>

  <button id="save-filters">Save Filters</button>
  <button id="reset-filters">Reset Filters</button>
  <button id="reload-kml">Reload Map</button>
</div>

<div id="map"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-omnivore/leaflet-omnivore.min.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.0/dist/leaflet.markercluster.js"></script>

<script>
$(document).ready(function() {
  const map = L.map('map').setView([3.139, 101.6869], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const markersCluster = L.markerClusterGroup();
  let allMarkers = [];

  // Sidebar toggle functionality
  $('#toggleSidebar').click(() => $('#sidebar').toggle());

  // Update range displays
  function updateRangeDisplays() {
    $('#price-output').text(`RM 0 - RM ${parseInt($('#price-range').val()).toLocaleString()}`);
    $('#builtup-output').text(`0 - ${parseInt($('#builtup-range').val()).toLocaleString()} sq.ft`);
  }

  // Parse auction date safely
  function parseAuctionDate(dateString) {
    if (!dateString) return null;
    const datePart = dateString.split('(')[0].trim();
    const dateObj = new Date(datePart);
    return isNaN(dateObj.getTime()) ? null : dateObj;
  }

  // Load KML data
  function loadKML() {
    markersCluster.clearLayers();
    allMarkers = [];

    console.log("Loading KML data...");
    omnivore.kml('auction_listings.kml')
      .on('ready', function(e) {
        console.log("KML data loaded successfully.");
        e.target.getLayers().forEach(layer => {
          if (!layer.feature || !layer.feature.geometry) return;
          
          const property = layer.feature.properties;
          const description = property.description.replace(/<br\s*\/?>/gi, '\n');
          const lines = description.split('\n').map(l => l.trim()).filter(l => l !== '');

          let price = 0, builtUp = 0, auctionDate = '', auctionType = '', tenure = '', 
              propertyType = '', pricePSF = '', auctionCount = '', transits = [];
              
          lines.forEach(line => {
            if (line.startsWith('Price:')) {
              const raw = line.split('Price:')[1].replace('Starting Bid','').replace('RM','').replace(/,/g,'').trim();
              price = parseFloat(raw) || 0;
            } else if (line.startsWith('Property Type:')) {
              propertyType = line.split(':')[1].trim();
            } else if (line.startsWith('Built-up:')) {
              builtUp = parseFloat(line.split(':')[1].replace('sq.ft','').replace(',','').trim()) || 0;
            } else if (line.startsWith('Auction Date:')) {
              auctionDate = line.split(':')[1].trim();
            } else if (line.startsWith('Auction Type:')) {
              auctionType = line.split(':')[1].trim();
            } else if (line.startsWith('Tenure:')) {
              tenure = line.split(':')[1].trim();
            } else if (line.startsWith('Price per Sq.Ft:')) {
              pricePSF = line.split(':')[1].trim();
            } else if (line.startsWith('Auction Count:')) {
              auctionCount = line.split(':')[1].trim();
            } else if (line.includes('Station') || line.includes('LRT') || line.includes('MRT')) {
              transits.push(line.replace(/\([^)]*\)/g, '').trim());
            }
          });

          const coords = layer.feature.geometry.coordinates;
          if (!coords || coords.length < 2) return;
          
          const lat = coords[1];
          const lng = coords[0];
          if (isNaN(lat) || isNaN(lng)) return;

          const top5TransitsHTML = transits.length > 0 
              ? `<ul>${transits.slice(0,5).map(t => `<li>${t}</li>`).join('')}</ul>` 
              : 'N/A';

          layer.bindPopup(`
              <strong>Property Type: ${propertyType}</strong><br>
              Auction Date: ${auctionDate}<br>
              Price: RM ${price.toLocaleString()}<br>
              Price per Sq.Ft: RM ${pricePSF}<br>
              Auction Type: ${auctionType}<br>
              Tenure: ${tenure}<br>
              Built-up: ${builtUp} sq.ft<br>
              Auction Count: ${auctionCount}<br>
              Top 5 Nearest Transit Stations:<br>
              ${top5TransitsHTML}
          `);

          layer.options.customData = { 
            propertyType, price, builtUp, 
            auctionDate, auctionType, tenure, 
            pricePSF, auctionCount, transits 
          };
          layer.options.renderer = L.canvas();

          markersCluster.addLayer(layer);
          allMarkers.push(layer);
        });

        map.addLayer(markersCluster);
        console.log(`Total markers added: ${allMarkers.length}`);
        
        populateDropdowns();
        setDynamicRanges();
        applySavedFilters();
      })
      .on('error', function(e) {
        console.error('KML loading error:', e.error);
        alert('Failed to load property data. Please check console for details.');
      })
      .addTo(map);
  }

  // Populate dropdown filters
  function populateDropdowns() {
    $('#property-type').html('<option value="">All Types</option>');
    $('#auction-type').html('<option value="">All Types</option>');
    $('#transit').empty();

    const propertyTypes = new Set();
    const auctionTypes = new Set();
    const stations = new Set();

    allMarkers.forEach(m => {
      if (m.options.customData.propertyType) {
        propertyTypes.add(m.options.customData.propertyType);
      }
      if (m.options.customData.auctionType) {
        auctionTypes.add(m.options.customData.auctionType);
      }
      m.options.customData.transits.forEach(t => stations.add(t));
    });

    [...propertyTypes].sort().forEach(t => 
      $('#property-type').append(`<option value="${t}">${t}</option>`));
      
    [...auctionTypes].sort().forEach(t => 
      $('#auction-type').append(`<option value="${t}">${t}</option>`));
      
    [...stations].sort().forEach(t => 
      $('#transit').append(`<option value="${t}">${t}</option>`));
  }

  // Set dynamic range limits based on data
  function setDynamicRanges() {
    const prices = allMarkers.map(m => m.options.customData.price).filter(p => p > 0);
    const builtups = allMarkers.map(m => m.options.customData.builtUp).filter(b => b > 0);
    
    if (prices.length > 0) {
      const maxPrice = Math.ceil(Math.max(...prices) / 100000) * 100000;
      $('#price-range').attr('max', maxPrice).val(maxPrice);
    }
    
    if (builtups.length > 0) {
      const maxBuiltup = Math.ceil(Math.max(...builtups) / 100) * 100;
      $('#builtup-range').attr('max', maxBuiltup).val(maxBuiltup);
    }
    
    updateRangeDisplays();
  }

  // Apply filters
  function applyFilters() {
    const propertyType = $('#property-type').val();
    const startDate = parseAuctionDate($('#auction-start').val());
    const endDate = parseAuctionDate($('#auction-end').val());
    const maxPrice = parseFloat($('#price-range').val()) || Infinity;
    const maxBuiltup = parseFloat($('#builtup-range').val()) || Infinity;
    const tenure = $('#tenure').val();
    const auctionType = $('#auction-type').val();
    const transitSelected = $('#transit').val() || [];

    markersCluster.clearLayers();

    const filtered = allMarkers.filter(m => {
      const d = m.options.customData;
      const auctionDate = parseAuctionDate(d.auctionDate);

      // Check each filter condition
      if (propertyType && d.propertyType !== propertyType) return false;
      if (auctionType && d.auctionType !== auctionType) return false;
      if (tenure && d.tenure !== tenure) return false;
      if (d.price > maxPrice) return false;
      if (d.builtUp > maxBuiltup) return false;
      if (startDate && (!auctionDate || auctionDate < startDate)) return false;
      if (endDate && (!auctionDate || auctionDate > endDate)) return false;
      if (transitSelected.length > 0 && !d.transits.some(t => transitSelected.includes(t))) return false;

      return true;
    });

    console.log(`Filtered markers: ${filtered.length}`);
    filtered.forEach(m => markersCluster.addLayer(m));

    if (filtered.length > 0) {
      const bounds = L.latLngBounds(filtered.map(m => m.getLatLng()));
      map.fitBounds(bounds);
    } else {
      map.setView([3.139, 101.6869], 12);
      alert('No properties match current filters');
    }
  }

  // Save filters to localStorage
  function saveFilters() {
    const filters = {
      propertyType: $('#property-type').val(),
      start: $('#auction-start').val(),
      end: $('#auction-end').val(),
      price: $('#price-range').val(),
      builtup: $('#builtup-range').val(),
      tenure: $('#tenure').val(),
      auctionType: $('#auction-type').val(),
      transit: $('#transit').val() || []
    };
    localStorage.setItem('auctionFilters', JSON.stringify(filters));
    alert('Filters saved successfully');
  }

  // Apply saved filters
  function applySavedFilters() {
    const savedFilters = localStorage.getItem('auctionFilters');
    if (savedFilters) {
      const filters = JSON.parse(savedFilters);

      $('#property-type').val(filters.propertyType || '');
      $('#auction-start').val(filters.start || '');
      $('#auction-end').val(filters.end || '');
      $('#price-range').val(filters.price || $('#price-range').attr('max'));
      $('#builtup-range').val(filters.builtup || $('#builtup-range').attr('max'));
      $('#tenure').val(filters.tenure || '');
      $('#auction-type').val(filters.auctionType || '');
      $('#transit').val(filters.transit || []);
      
      updateRangeDisplays();
      applyFilters();
    }
  }

  // Event listeners
  $('#price-range, #builtup-range').on('input', updateRangeDisplays);
  
  $('#property-type, #auction-start, #auction-end, #tenure, #auction-type, #transit').on('change', applyFilters);
  
  $('#save-filters').on('click', saveFilters);
  
  $('#reset-filters').on('click', function() {
    localStorage.removeItem('auctionFilters');
    location.reload();
  });
  
  $('#reload-kml').on('click', function() {
    location.reload();
  });

  // Initialize
  loadKML();
});
</script>
</body>
</html>