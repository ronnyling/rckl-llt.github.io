<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Auction Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.0/dist/leaflet.markercluster.css" />
    <style>
        #map { height: 100vh; }
        #sidebar { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            background: rgba(255, 255, 255, 0.9); 
            padding: 20px; 
            z-index: 1000; 
            border-radius: 8px;
            max-width: 300px;
        }
        #filter-content {
            margin-top: 10px;
            display: block; /* visible by default */
        }
        .filter-container { margin-bottom: 15px; }
        .filter-container label { font-weight: bold; }
        .filter-container select, .filter-container input { width: 100%; }
        button { margin-top: 10px; width: 100%; }
    </style>
</head>
<body>

    <!-- Sidebar for Filters -->
    <div id="sidebar">
        <button onclick="toggleFilters()">Toggle Filters</button>

        <div id="filter-content">
            <h3>Filters</h3>

            <div class="filter-container">
                <label for="property-type">Property Type</label>
                <select id="property-type">
                    <option value="">All Types</option>
                    <option value="Apartment">Apartment</option>
                    <option value="Retail Lot">Retail Lot</option>
                    <option value="Office">Office</option>
                    <option value="Industrial">Industrial</option>
                </select>
            </div>

            <div class="filter-container">
                <label for="auction-date">Auction Date</label>
                <input type="date" id="auction-date">
            </div>

            <div class="filter-container">
                <label for="price-range">Price Range (RM)</label>
                <input type="range" id="price-range" min="0" max="10000000" step="100000" />
                <div id="price-output">RM 0 - RM 10,000,000</div>
            </div>

            <div class="filter-container">
                <label for="tenure">Tenure</label>
                <select id="tenure">
                    <option value="">All Tenures</option>
                    <option value="Freehold">Freehold</option>
                    <option value="Leasehold">Leasehold</option>
                </select>
            </div>

            <button id="reset-filters">Reset Filters</button>
            <button id="reload-kml">Reload KML</button>
        </div>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-omnivore/leaflet-omnivore.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.0/dist/leaflet.markercluster.js"></script>

    <script>
        // Collapsible Filter Panel
        function toggleFilters() {
            var filterContent = document.getElementById('filter-content');
            if (filterContent.style.display === "none") {
                filterContent.style.display = "block";
            } else {
                filterContent.style.display = "none";
            }
        }

        // Cache filter values
        function saveFilters() {
            const filters = {
                propertyType: document.getElementById('property-type').value,
                auctionDate: document.getElementById('auction-date').value,
                priceRange: document.getElementById('price-range').value,
                tenure: document.getElementById('tenure').value
            };
            localStorage.setItem('auctionMapFilters', JSON.stringify(filters));
        }

        function loadFilters() {
            const saved = localStorage.getItem('auctionMapFilters');
            if (saved) {
                const filters = JSON.parse(saved);
                document.getElementById('property-type').value = filters.propertyType;
                document.getElementById('auction-date').value = filters.auctionDate;
                document.getElementById('price-range').value = filters.priceRange;
                document.getElementById('tenure').value = filters.tenure;
                $('#price-output').text(`RM 0 - RM ${filters.priceRange}`);
            }
        }

        const map = L.map('map').setView([3.139, 101.6869], 12);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const markersCluster = L.markerClusterGroup();

        function loadKML() {
            omnivore.kml('auction_listings.kml')
                .on('ready', function (e) {
                    var layers = e.target.getLayers();
                    layers.forEach(function (layer) {
                        const property = layer.feature.properties;
                        let description = property.description.replace(/<br\s*\/?>/gi, '\n');
                        let lines = description.split('\n').map(line => line.trim()).filter(line => line !== '');
                        let price = '', auctionDate = '', auctionType = '', tenure = '', propertyType = '', builtUp = '', address = '', pricePsf = '', auctionCount = '', top5Transits = [];
                        let collectingTransit = false;
                        lines.forEach(line => {
                            if (line.includes('Price:') && !line.includes('Price per Sq.Ft')) price = line.split(':')[1].trim();
                            else if (line.includes('Auction Date:')) auctionDate = line.split(':')[1].trim();
                            else if (line.includes('Auction Type:')) auctionType = line.split(':')[1].trim();
                            else if (line.includes('Tenure:')) tenure = line.split(':')[1].trim();
                            else if (line.includes('Property Type:')) propertyType = line.split(':')[1].trim();
                            else if (line.includes('Built-up:')) builtUp = line.split(':')[1].trim();
                            else if (line.includes('Address:')) address = line.split(':')[1].trim();
                            else if (line.includes('Price per Sq.Ft:')) pricePsf = line.split(':')[1].trim();
                            else if (line.includes('Auction Count:')) auctionCount = line.split(':')[1].trim();
                            else if (line.includes('Top 5 Nearest Transit Stations:')) collectingTransit = true;
                            else if (collectingTransit && top5Transits.length < 5) top5Transits.push(line);
                        });
                        price = price.replace('RM', '').replace(/\s/g, '').replace(/,/g, '');
                        builtUp = builtUp || '0';
                        const numericPrice = parseFloat(price);
                        const coordinates = layer.feature.geometry.coordinates;
                        const latitude = coordinates[1];
                        const longitude = coordinates[0];
                        if (isNaN(latitude) || isNaN(longitude) || latitude === 'nan' || longitude === 'nan') return;
                        const top5TransitsHTML = top5Transits.length > 0 ? `<ul>${top5Transits.map(t => `<li>${t}</li>`).join('')}</ul>` : 'N/A';
                        layer.bindPopup(`
                            <strong>PSF (RM): ${pricePsf}</strong><br>
                            <strong>${property.name}</strong><br>
                            Auction Date: ${auctionDate}<br>
                            Price: RM ${numericPrice}<br>
                            Auction Type: ${auctionType}<br>
                            Tenure: ${tenure}<br>
                            Property Type: ${propertyType}<br>
                            Built-up: ${builtUp}<br>
                            Address: ${address}<br>
                            Count: ${auctionCount}<br>
                            Top 5 Nearest Transit Stations:<br>
                            ${top5TransitsHTML}
                        `);
                        markersCluster.addLayer(layer);
                    });
                    map.addLayer(markersCluster);
                })
                .addTo(map);
        }

        loadKML();

        document.getElementById('reload-kml').addEventListener('click', function() {
            markersCluster.clearLayers();
            loadKML();
        });

        function applyFilters() {
            const propertyType = document.getElementById('property-type').value;
            const auctionDate = document.getElementById('auction-date').value;
            const priceRange = parseFloat(document.getElementById('price-range').value);
            const tenure = document.getElementById('tenure').value;
            saveFilters(); // Save whenever applying filters

            const filteredActiveProperties = [];
            markersCluster.eachLayer(function (marker) {
                const properties = marker.feature.properties;
                const description = properties.description;
                let isTypeMatch = propertyType ? description.includes(propertyType) : true;
                let isDateMatch = auctionDate ? description.includes(auctionDate) : true;
                let isPriceMatch = true;
                let isTenureMatch = tenure ? description.includes(tenure) : true;
                if (description.includes('Price:')) {
                    const match = description.match(/Price:\s*RM\s*([\d,]+)/i);
                    if (match && parseFloat(match[1].replace(/,/g, '')) > priceRange) isPriceMatch = false;
                }
                if (isTypeMatch && isDateMatch && isPriceMatch && isTenureMatch) {
                    filteredActiveProperties.push(marker);
                }
            });

            markersCluster.clearLayers();
            filteredActiveProperties.forEach(marker => markersCluster.addLayer(marker));

            if (filteredActiveProperties.length > 0) {
                const bounds = L.latLngBounds(filteredActiveProperties.map(marker => marker.getLatLng()));
                map.fitBounds(bounds);
            }
        }

        $('#property-type, #auction-date, #price-range, #tenure').on('change', applyFilters);

        $('#price-range').on('input', function () {
            $('#price-output').text(`RM 0 - RM ${$(this).val()}`);
        });

        $('#reset-filters').on('click', function () {
            localStorage.removeItem('auctionMapFilters');
            location.reload();
        });

        // Load filters when page loads
        $(document).ready(function() {
            loadFilters();
            applyFilters();
        });
    </script>
</body>
</html>
