<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Property Auction Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.0/dist/leaflet.markercluster.css" />
  <style>
    #map { height: 100vh; }
    #sidebar { 
      position: absolute; 
      top: 60px; 
      left: 10px; 
      background: rgba(255, 255, 255, 0.9); 
      padding: 15px; 
      z-index: 1000; 
      border-radius: 8px;
      max-width: 250px;
      display: none; /* Initially hidden */
    }
    #toggle-sidebar {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1200;
      background: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      cursor: pointer;
    }
    .filter-container { margin-bottom: 15px; }
    .filter-container label { font-weight: bold; }
    .filter-container select, .filter-container input { width: 100%; }
    #save-filters { margin-top: 10px; width: 100%; }
  </style>
</head>
<body>

<!-- Toggle Sidebar Button -->
<button id="toggle-sidebar">Filters</button>

<!-- Sidebar -->
<div id="sidebar">
  <h3>Filters</h3>

  <div class="filter-container">
    <label for="property-type">Property Type</label>
    <select id="property-type"></select>
  </div>

  <div class="filter-container">
    <label for="auction-date">Auction Date</label>
    <input type="date" id="auction-date">
  </div>

  <div class="filter-container">
    <label for="price-range">Price Range (RM)</label>
    <input type="range" id="price-range" min="0" max="10000000" step="100000" />
    <div id="price-output">RM 0 - RM 10,000,000</div>
  </div>

  <div class="filter-container">
    <label for="tenure">Tenure</label>
    <select id="tenure"></select>
  </div>

  <div class="filter-container">
    <label for="transit">Nearby Transit Station</label>
    <select id="transit"></select>
  </div>

  <button id="save-filters">Save Filters</button>
  <button id="reset-filters">Reset Filters</button>
  <button id="reload-kml">Reload KML</button>
</div>

<!-- Map -->
<div id="map"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-omnivore/leaflet-omnivore.min.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.0/dist/leaflet.markercluster.js"></script>

<script>
const map = L.map('map').setView([3.139, 101.6869], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const markersCluster = L.markerClusterGroup();

let allMarkers = [];
let propertyTypes = new Set();
let tenures = new Set();
let transitStations = new Set();

function loadKML() {
  markersCluster.clearLayers();
  allMarkers = [];
  propertyTypes.clear();
  tenures.clear();
  transitStations.clear();

  omnivore.kml('auction_listings.kml')
    .on('ready', function (e) {
      const layers = e.target.getLayers();

      layers.forEach(function (layer) {
        const property = layer.feature.properties;
        const description = property.description.replace(/<br\s*\/?>/gi, '\n');
        const lines = description.split('\n').map(l => l.trim()).filter(l => l);

        let item = {transits: []};

        lines.forEach(line => {
          if (line.includes('Property Type:')) item.propertyType = line.split(':')[1].trim();
          if (line.includes('Tenure:')) item.tenure = line.split(':')[1].trim();
          if (line.includes('Auction Date:')) item.auctionDate = line.split(':')[1].trim();
          if (line.includes('Price:') && !line.includes('Price per Sq.Ft')) item.price = line.split(':')[1].trim().replace('RM','').replace(/,/g,'').trim();
          if (line.includes('Top 5 Nearest Transit Stations:')) item.collectingTransit = true;
          else if (item.collectingTransit && line) item.transits.push(line);
          if (item.transits.length >= 5) item.collectingTransit = false;
        });

        item.layer = layer;
        allMarkers.push(item);

        propertyTypes.add(item.propertyType);
        tenures.add(item.tenure);
        item.transits.forEach(t => transitStations.add(t));

        layer.bindPopup(`
          <strong>${item.propertyType || ''}</strong><br>
          Auction Date: ${item.auctionDate || ''}<br>
          Price: RM ${item.price || ''}<br>
          Tenure: ${item.tenure || ''}<br>
          Nearby Transits:<br><ul>${item.transits.map(t => `<li>${t}</li>`).join('')}</ul>
        `);

        markersCluster.addLayer(layer);
      });

      map.addLayer(markersCluster);
      populateFilters();
      restoreSavedFilters();
    }).addTo(map);
}

function populateFilters() {
  $('#property-type').html('<option value="">All Types</option>' + Array.from(propertyTypes).map(pt => `<option value="${pt}">${pt}</option>`).join(''));
  $('#tenure').html('<option value="">All Tenures</option>' + Array.from(tenures).map(t => `<option value="${t}">${t}</option>`).join(''));
  $('#transit').html('<option value="">All Transits</option>' + Array.from(transitStations).map(tr => `<option value="${tr}">${tr}</option>`).join(''));
}

function applyFilters() {
  const selectedType = $('#property-type').val();
  const selectedDate = $('#auction-date').val();
  const selectedPrice = parseFloat($('#price-range').val());
  const selectedTenure = $('#tenure').val();
  const selectedTransit = $('#transit').val();

  markersCluster.clearLayers();

  allMarkers.forEach(item => {
    let match = true;

    if (selectedType && item.propertyType !== selectedType) match = false;
    if (selectedTenure && item.tenure !== selectedTenure) match = false;
    if (selectedTransit && !item.transits.includes(selectedTransit)) match = false;
    if (!isNaN(selectedPrice) && item.price && parseFloat(item.price) > selectedPrice) match = false;
    if (selectedDate && item.auctionDate !== selectedDate) match = false;

    if (match) markersCluster.addLayer(item.layer);
  });
}

function saveFilters() {
  const filters = {
    propertyType: $('#property-type').val(),
    auctionDate: $('#auction-date').val(),
    priceRange: $('#price-range').val(),
    tenure: $('#tenure').val(),
    transit: $('#transit').val()
  };
  localStorage.setItem('auctionFilters', JSON.stringify(filters));
}

function restoreSavedFilters() {
  const saved = JSON.parse(localStorage.getItem('auctionFilters'));
  if (saved) {
    $('#property-type').val(saved.propertyType);
    $('#auction-date').val(saved.auctionDate);
    $('#price-range').val(saved.priceRange);
    $('#tenure').val(saved.tenure);
    $('#transit').val(saved.transit);
    applyFilters();
  }
}

$('#property-type, #auction-date, #price-range, #tenure, #transit').on('change', applyFilters);
$('#save-filters').on('click', saveFilters);
$('#reset-filters').on('click', function() { localStorage.removeItem('auctionFilters'); location.reload(); });
$('#reload-kml').on('click', loadKML);

$('#price-range').on('input', function () {
  $('#price-output').text(`RM 0 - RM ${$(this).val()}`);
});

$('#toggle-sidebar').on('click', function() {
  $('#sidebar').toggle();
});

loadKML();
</script>

</body>
</html>
